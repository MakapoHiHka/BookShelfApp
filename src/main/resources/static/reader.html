<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–∏—Ç–∞–ª–∫–∞ ‚Äî BookShelf</title>
  <style>
    body {
      margin: 0;
      background: #fafafa;
      font-family: serif;
    }
    #reader-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .book-page {
      display: none;
    }
    .book-page.active {
      display: block;
    }
    #nav {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>

<div id="reader-container"></div>
<div id="nav">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="currentPage">1</span></div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const bookId = urlParams.get('bookId');
  if (!bookId) {
    alert('–ù–µ —É–∫–∞–∑–∞–Ω ID –∫–Ω–∏–≥–∏');
    window.location.href = 'bookShelf/bookshelf.html';
  }

  const token = localStorage.getItem('jwtToken');
  if (!token) {
    window.location.href = 'bookShelf/login.html';
  }

  let totalPages = 1;
  let currentPage = 1;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º HTML-–∫–æ–Ω—Ç–µ–Ω—Ç –∫–Ω–∏–≥–∏
  fetch(`/bookShelf/api/books/${bookId}/content`, {
    headers: { 'Authorization': 'Bearer ' + token }
  })
  .then(res => {
    if (!res.ok) throw new Error('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
    return res.text();
  })
  .then(html => {
    document.getElementById('reader-container').innerHTML = html;
    initReader();
  })
  .catch(err => {
    document.getElementById('reader-container').innerHTML =
      `<p style="padding:20px; color:red;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
  });

function initReader() {
  const pages = document.querySelectorAll('.book-page');
  totalPages = pages.length;

  // –ß–∏—Ç–∞–µ–º –∂–µ–ª–∞–µ–º—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ URL
  const urlParams = new URLSearchParams(window.location.search);
  let requestedPage = parseInt(urlParams.get('page'), 10);

  // –ï—Å–ª–∏ page –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º —Å 1
  if (isNaN(requestedPage) || requestedPage < 1 || requestedPage > totalPages) {
    requestedPage = 1;
  }

  // —á—Ç–æ–±—ã –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ–ª–∞ –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      showPage(requestedPage);
    });
  });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight') showPage(currentPage + 1);
    if (e.key === 'ArrowLeft')  showPage(currentPage - 1);
  });
}

function showPage(pageNum) {
  if (pageNum < 1) pageNum = 1;
  if (pageNum > totalPages) pageNum = totalPages;
  if (pageNum === currentPage) return;

  const pages = document.querySelectorAll('.book-page');
  pages.forEach((el, i) => {
    el.classList.toggle('active', i === pageNum - 1);
  });

  currentPage = pageNum;
  document.getElementById('currentPage').textContent = currentPage;

  // üîπ –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
  const url = new URL(window.location);
  url.searchParams.set('page', currentPage);
  window.history.replaceState(null, '', url);

  sendProgress(currentPage, totalPages);
}

function sendProgress(page, total) {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                console.warn('No token found. User not authenticated.');
                return;
            }
            fetch(`/bookShelf/api/books/${bookId}/progress`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    pageNumber: page
                })
            }).catch(err => console.warn('Progress send failedHUI:', err));
        }
</script>

</body>
</html>